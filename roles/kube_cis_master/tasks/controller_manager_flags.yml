# 1.3.1 Ensure that the --terminated-pod-gc-threshold
- name: 1.3.1 Ensure that the --terminated-pod-gc-threshold
  block:
    - name: Ensure that the --terminated-pod-gc-threshold (1.3.1)
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        regexp: '^\s*-\s+--terminated-pod-gc-threshold=.*$'
        line: "    - --terminated-pod-gc-threshold={{ garbage_collector_terminated }}"
        state: present
        insertafter: '^\s+- kube-controller-manager$'
      when: controller_manager_manifest is defined

    - name: ğŸŸ¢ Task 1.3.1 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.1 Ensure that the --terminated-pod-gc-threshold"

  rescue:
    - name: ğŸ”´ Task 1.3.1 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.1 Failed setting on {{ inventory_hostname }}. Execution stopped."


# 1.3.2 Ensure that the --profiling argument is set to false
- name: 1.3.2 Ensure that the --profiling argument is set to false
  block:
    - name: Ensure that the --profiling argument is set to false (1.3.2)
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        regexp: '^\s*-\s+--profiling=.*$'
        line: "    - --profiling=false"
        state: present
        insertafter: '^\s+- kube-controller-manager$'
      when: controller_manager_manifest is defined

    - name: ğŸŸ¢ Task 1.3.2 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.2 Ensure that the --profiling argument is set to false"

  rescue:
    - name: ğŸ”´ Task 1.3.2 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.2 Failed setting on {{ inventory_hostname }}. Execution stopped."

# 1.3.3 Ensure that the --use-service-account-credentials
- name: 1.3.3 Ensure that the --use-service-account-credentials
  block:
    - name: Ensure that the --use-service-account-credentials argument is set to false (1.3.3)
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        regexp: '^\s*-\s+--use-service-account-credentials=.*$'
        line: "    - --use-service-account-credentials=true"
        state: present
        insertafter: '^\s+- kube-controller-manager$'
      when: controller_manager_manifest is defined

    - name: ğŸŸ¢ Task 1.3.3 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.3 Ensure that the --use-service-account-credentials"

  rescue:
    - name: ğŸ”´ Task 1.3.3 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.3 Failed setting on {{ inventory_hostname }}. Execution stopped."

# 1.3.4 Ensure that the --service-account-private-key-file

- name: 1.3.4 Ensure that the --service-account-private-key-file
  block:
    - name: 1.3.4 [Update/Replace] --service-account-private-key-file argument
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        state: present
        regexp: '^\s*-\s+--service-account-private-key-file=.*$'
        line: '    - --service-account-private-key-file={{ service_account_private_key_file }}'
        backrefs: true
      register: sa_key_update
    - name: 1.3.4 [Insert] --service-account-private-key-file if not present
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        state: present
        line: '    - --service-account-private-key-file={{ service_account_private_key_file }}'
        insertafter: '^\s+- kube-controller-manager$'
      when: not sa_key_update.changed

    - name: ğŸŸ¢ Task 1.3.4 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.4 Ensure that the --service-account-private-key-file"

  rescue:
    - name: ğŸ”´ Task 1.3.4 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.4 Failed setting on {{ inventory_hostname }}. Execution stopped."

# 1.3.5 Ensure that the --root-ca-file 

- name: 1.3.5 Ensure that the --root-ca-file
  block:
    - name: 1.3.5 [Update/Replace] --root-ca-file argument
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        state: present
        regexp: '^\s*-\s+--root-ca-file=.*$'
        line: '    - --root-ca-file={{ ca_path }}'
        backrefs: true
      register: root_ca_update
    - name: 1.3.5 [Insert] --root-ca-file if not present
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        state: present
        line: '    - --root-ca-file={{ ca_path }}'
        insertafter: '^\s+- kube-controller-manager$'
      when: not root_ca_update.changed

    - name: ğŸŸ¢ Task 1.3.5 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.5 Ensure that the --root-ca-file is set to {{ ca_path }}"

  rescue:
    - name: ğŸ”´ Task 1.3.5 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.5 Failed setting on {{ inventory_hostname }}. Execution stopped."

# 1.3.6 Ensure that the RotateKubeletServerCertificate  

- name: 1.3.6 Ensure that the RotateKubeletServerCertificate 
  block:
    - name: Ensure that the RotateKubeletServerCertificate argument is set to true (1.3.6)
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        regexp: '^\s*-\s+--feature-gates=.*$'
        line: "    - --feature-gates=RotateKubeletServerCertificate=true"
        state: present
        insertafter: '^\s+- kube-controller-manager$'
      when: controller_manager_manifest is defined

    - name: ğŸŸ¢ Task 1.3.6 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.6 Ensure that the RotateKubeletServerCertificate"

  rescue:
    - name: ğŸ”´ Task 1.3.6 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.6 Failed setting on {{ inventory_hostname }}. Execution stopped."

# 1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1

- name: 1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1
  block:
    - name: Ensure that the --bind-address (1.3.7)
      ansible.builtin.lineinfile:
        path: "{{ controller_manager_manifest }}"
        regexp: '^\s*-\s+--bind-address=.*$'
        line: "    - --bind-address=127.0.0.1"
        state: present
        insertafter: '^\s+- kube-controller-manager$'
      when: controller_manager_manifest is defined

    - name: Slurp Scheduler Manifest file
      ansible.builtin.slurp:
        src: "{{ controller_manager_manifest }}"
      register: slurped_manifest
      when: controller_manager_manifest is defined

    - name: Initialize base Manifest variables
      ansible.builtin.set_fact:
        current_manifest: "{{ slurped_manifest.content | b64decode | from_yaml }}"
        original_container: "{{ (slurped_manifest.content | b64decode | from_yaml).spec.containers[0] }}"
        new_httpget_config:
          httpGet:
            host: 127.0.0.1
      when: slurped_manifest.content is defined
    
    - name: Compute the updated container object (Inline Logic)
      ansible.builtin.set_fact:
        updated_container: >
          {{ original_container | combine({
             'livenessProbe': original_container.livenessProbe | combine({
                'httpGet': original_container.livenessProbe.httpGet | combine(new_httpget_config.httpGet, recursive=True)
             }, recursive=True),
             'startupProbe': original_container.startupProbe | combine({
                'httpGet': original_container.startupProbe.httpGet | combine(new_httpget_config.httpGet, recursive=True)
             }, recursive=True)
          }, recursive=True) }}
      when: original_container is defined

    - name: Write back Manifest with updated Probes
      ansible.builtin.copy:
        content: >
          {{ current_manifest | combine({
             'spec': {
               'containers': [ updated_container ] 
             }
           }, recursive=True) | to_nice_yaml(indent=2) }}
        dest: "{{ controller_manager_manifest }}"
      when: updated_container is defined
    - name: ğŸŸ¢ Task 1.3.7 completed status
      ansible.builtin.debug:
        msg: "âœ… CIS 1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1"

  rescue:
    - name: ğŸ”´ Task 1.3.7 Status FAIL
      ansible.builtin.debug:
        msg: "ğŸ›‘ FAIL: CIS 1.3.7 Failed setting on {{ inventory_hostname }}. Execution stopped."
